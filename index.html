<!DOCTYPE html>
<html lang="ne">
<head>
<meta charset="UTF-8">
<title>note.me ‚Äì Book Editor</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">

<style>
@font-face{
  font-family:Kalimati;
  src:url('https://raw.githubusercontent.com/sajandhakal/Kalimati-Font/master/Kalimati.ttf');
}
body{margin:0;font-family:Kalimati,serif;height:100vh;display:flex;flex-direction:column}
header{background:#1e40af;color:#fff;padding:8px}
main{flex:1;display:flex}
#left{width:260px;background:#f1f5f9;padding:10px;overflow:auto}
#editorWrap{flex:1;display:flex;flex-direction:column}
.chapter{background:#fff;padding:6px;margin-bottom:4px;border-radius:4px;cursor:pointer}
.chapter.active{background:#dbeafe}
.toolbar button{margin:2px}
#editor{flex:1;font-size:18px;line-height:1.7}
</style>
</head>

<body>

<header>
  <input id="bookTitle" placeholder="‡§™‡•Å‡§∏‡•ç‡§§‡§ï ‡§∂‡•Ä‡§∞‡•ç‡§∑‡§ï" style="width:100%;font-size:18px">
</header>

<main>
  <div id="left">
    <button onclick="newBook()">üìò ‡§®‡§Ø‡§æ‡§Å ‡§ï‡§ø‡§§‡§æ‡§¨</button>
    <button onclick="addChapter()">‚ûï ‡§Ö‡§ß‡•ç‡§Ø‡§æ‡§Ø</button>
    <hr>
    <div id="chapters"></div>
  </div>

  <div id="editorWrap">
    <div class="toolbar">
      <button onclick="addTopic()">‚ûï ‡§µ‡§ø‡§∑‡§Ø</button>
      <button onclick="addPara()">‚ûï ‡§™‡§∞‡§ø‡§ö‡•ç‡§õ‡•á‡§¶</button>
      <button onclick="addTable()">‚ûï ‡§§‡§æ‡§≤‡§ø‡§ï‡§æ</button>
      <button onclick="insertCover()">üñºÔ∏è ‡§ï‡§≠‡§∞</button>
      <button onclick="insertTitlePage()">üìÑ Title</button>
      <button onclick="exportPDF()">üìÑ PDF</button>
      <button onclick="openReader()">üìñ Read</button>
    </div>
    <div id="editor"></div>
  </div>
</main>

<script src="https://cdn.quilljs.com/1.3.7/quill.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<script>
/* STORAGE */
let books = JSON.parse(localStorage.getItem('books')) || {};
let currentBookId = localStorage.getItem('currentBookId');

function saveAll(){
  localStorage.setItem('books', JSON.stringify(books));
  localStorage.setItem('currentBookId', currentBookId);
}

/* BOOK */
function newBook(){
  const id=Date.now();
  books[id]={title:'',chapters:[],current:null};
  currentBookId=id;
  saveAll();
  loadBook(id);
}

function loadBook(id){
  currentBookId=id;
  book=books[id];
  document.getElementById('bookTitle').value=book.title;
  renderChapters();
  if(book.current) loadChapter(book.current);
  else q.setText('');
}

let book = books[currentBookId] || {title:'',chapters:[],current:null};

document.getElementById('bookTitle').oninput=e=>{
  book.title=e.target.value; saveAll();
};

/* QUILL */
const q=new Quill('#editor',{
  theme:'snow',
  modules:{toolbar:[
    [{header:[1,2,3,false]}],
    ['bold','italic','underline'],
    [{list:'ordered'},{list:'bullet'}],
    ['image'],['clean']
  ]}
});

/* CHAPTER */
function addChapter(){
  const t=prompt("‡§Ö‡§ß‡•ç‡§Ø‡§æ‡§Ø ‡§∂‡•Ä‡§∞‡•ç‡§∑‡§ï");
  if(!t)return;
  const c={id:Date.now(),title:t,content:''};
  book.chapters.push(c); book.current=c.id;
  saveAll(); renderChapters(); loadChapter(c.id);
}

function renderChapters(){
  const box=document.getElementById('chapters');
  box.innerHTML='';
  book.chapters.forEach(c=>{
    const d=document.createElement('div');
    d.className='chapter'+(c.id===book.current?' active':'');
    d.innerHTML=`${c.title}
      <span style="float:right;color:red"
      onclick="deleteChapter(${c.id},event)">‚úñ</span>`;
    d.onclick=()=>loadChapter(c.id);
    box.appendChild(d);
  });
}

function deleteChapter(id,e){
  e.stopPropagation();
  if(!confirm("‡§π‡§ü‡§æ‡§â‡§®‡•á?"))return;
  book.chapters=book.chapters.filter(c=>c.id!==id);
  book.current=book.chapters[0]?.id||null;
  saveAll(); renderChapters();
  if(book.current) loadChapter(book.current); else q.setText('');
}

function loadChapter(id){
  const c=book.chapters.find(x=>x.id===id);
  if(!c)return;
  book.current=id;
  q.root.innerHTML=c.content;
  renderChapters();
}

q.on('text-change',()=>{
  const c=book.chapters.find(x=>x.id===book.current);
  if(c){c.content=q.root.innerHTML; saveAll();}
});

/* CONTENT */
function addTopic(){
  q.clipboard.dangerouslyPasteHTML(q.getSelection(true).index,
  `<h2>‡§µ‡§ø‡§∑‡§Ø ‡§∂‡•Ä‡§∞‡•ç‡§∑‡§ï</h2><p><br></p>`);
}
function addPara(){
  q.insertText(q.getSelection(true).index,"‡§™‡§∞‡§ø‡§ö‡•ç‡§õ‡•á‡§¶ ‡§≤‡•á‡§ñ‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç...\n");
}
function addTable(){
  q.clipboard.dangerouslyPasteHTML(q.getSelection(true).index,
  `<table border="1" style="width:100%">
  <tr><th>‡§∂‡•Ä‡§∞‡•ç‡§∑‡§ï</th><th>‡§∂‡•Ä‡§∞‡•ç‡§∑‡§ï</th></tr>
  <tr><td>‡§°‡§æ‡§ü‡§æ</td><td>‡§°‡§æ‡§ü‡§æ</td></tr></table><p><br></p>`);
}

/* FRONT MATTER */
function insertCover(){
  q.clipboard.dangerouslyPasteHTML(0,
  `<div style="text-align:center;padding:120px">
   <h1>${book.title}</h1></div><div style="page-break-after:always"></div>`);
}
function insertTitlePage(){
  q.clipboard.dangerouslyPasteHTML(0,
  `<div style="text-align:center;padding:120px">
   <h1>${book.title}</h1></div>
   <div style="page-break-after:always"></div>`);
}

/* PDF */
function exportPDF(){
  html2pdf().from(document.getElementById('editor')).save(book.title+'.pdf');
}

/* READER */
function openReader(){
  window.open('reader.html?book='+currentBookId,'_blank');
}

/* INIT */
if(currentBookId) loadBook(currentBookId);
</script>

</body>
</html>
