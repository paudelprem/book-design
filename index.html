<!DOCTYPE html>
<html lang="ne">
<head>
<meta charset="UTF-8">
<title>note.me ‚Äì Online Book Editor</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Quill -->
<link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">

<style>
@font-face{
  font-family: 'Kalimati';
  src: url('https://raw.githubusercontent.com/sajandhakal/Kalimati-Font/master/Kalimati.ttf');
}

body{
  margin:0;
  font-family:Kalimati, serif;
  height:100vh;
  display:flex;
  flex-direction:column;
}
header{
  background:#1e40af;
  color:#fff;
  padding:8px;
}
header input{
  width:100%;
  font-size:18px;
  padding:6px;
  font-family:Kalimati, serif;
}
main{flex:1;display:flex}
#left{
  width:260px;
  background:#f1f5f9;
  padding:10px;
  overflow:auto;
}
#editorWrap{flex:1;display:flex;flex-direction:column}
.toolbar{
  padding:6px;
  border-bottom:1px solid #ccc;
  background:#fafafa;
}
.toolbar button{margin:2px}
#editor{
  flex:1;
  font-size:18px;
  line-height:1.7;
  font-family:Kalimati, serif;
}
.chapter{
  background:#fff;
  padding:6px;
  margin-bottom:4px;
  border-radius:4px;
  cursor:pointer;
}
.chapter.active{background:#dbeafe}

/* table styles */
.table-grid td,.table-grid th{border:1px solid #000}
.table-borderless td,.table-borderless th{border:none}
.table-zebra tr:nth-child(even){background:#f8fafc}

/* table resize handle */
td,th{position:relative}
.col-resize{
  position:absolute;
  right:0; top:0;
  width:5px; height:100%;
  cursor:col-resize;
}
</style>
</head>

<body>

<header>
  <input id="bookTitle" placeholder="‡§™‡•Å‡§∏‡•ç‡§§‡§ï ‡§∂‡•Ä‡§∞‡•ç‡§∑‡§ï">
</header>

<main>
  <div id="left">
    <button onclick="newBook()">üìò ‡§®‡§Ø‡§æ‡§Å ‡§ï‡§ø‡§§‡§æ‡§¨</button>
    <button onclick="addChapter()">‚ûï ‡§Ö‡§ß‡•ç‡§Ø‡§æ‡§Ø</button>
    <hr>
    <div id="chapters"></div>
  </div>

  <div id="editorWrap">
    <div class="toolbar">
      <button onclick="addTopic()">‚ûï ‡§µ‡§ø‡§∑‡§Ø</button>
      <button onclick="addPara()">‚ûï ‡§™‡§∞‡§ø‡§ö‡•ç‡§õ‡•á‡§¶</button>
      <button onclick="addTable()">‚ûï Table</button>

      <!-- quick highlight -->
      <button onclick="hl('yellow')">üü®</button>
      <button onclick="hl('lightgreen')">üü©</button>
      <button onclick="hl('pink')">üü•</button>

      <!-- quick font colour -->
      <button onclick="fc('red')">üî¥</button>
      <button onclick="fc('blue')">üîµ</button>
      <button onclick="fc('black')">‚ö´</button>

      <!-- table controls -->
      <button onclick="addRowBelow()">‚ûï Row</button>
      <button onclick="addColRight()">‚ûï Col</button>
      <button onclick="delRow()">‚ûñ Row</button>
      <button onclick="delCol()">‚ûñ Col</button>
      <button onclick="toggleHeader()">üîÅ Header</button>

      <!-- table style -->
      <button onclick="setTableStyle('grid')">‚ñ¶</button>
      <button onclick="setTableStyle('borderless')">‚ñ¢</button>
      <button onclick="setTableStyle('zebra')">‚ñ§</button>

      <button onclick="exportPDF()">üìÑ PDF</button>
      <button onclick="openReader()">üìñ Read</button>
    </div>

    <div id="editor"></div>
  </div>
</main>

<!-- libs -->
<script src="https://cdn.quilljs.com/1.3.7/quill.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<script>
/* ---------- MULTI BOOK STORAGE ---------- */
let books = JSON.parse(localStorage.getItem('books')) || {};
let currentBookId = localStorage.getItem('currentBookId');
let book = books[currentBookId] || { title:'', chapters:[], current:null };

function saveAll(){
  books[currentBookId] = book;
  localStorage.setItem('books', JSON.stringify(books));
  localStorage.setItem('currentBookId', currentBookId);
}

/* ---------- NEW / LOAD BOOK ---------- */
function newBook(){
  currentBookId = Date.now().toString();
  book = { title:'', chapters:[], current:null };
  saveAll();
  renderChapters();
  q.setText('');
  document.getElementById('bookTitle').value='';
}

document.getElementById('bookTitle').value = book.title || '';
document.getElementById('bookTitle').oninput = e=>{
  book.title = e.target.value;
  saveAll();
};

/* ---------- QUILL (Font colour + Highlight enabled) ---------- */
const q = new Quill('#editor',{
  theme:'snow',
  modules:{
    toolbar:[
      [{ header:[1,2,3,false] }],
      ['bold','italic','underline','strike'],
      [{ color:[] }, { background:[] }],   // üé® font colour + highlight
      [{ list:'ordered' }, { list:'bullet' }],
      ['image'],
      ['clean']
    ]
  }
});

/* ---------- CHAPTER ---------- */
function addChapter(){
  const t = prompt("‡§Ö‡§ß‡•ç‡§Ø‡§æ‡§Ø ‡§∂‡•Ä‡§∞‡•ç‡§∑‡§ï");
  if(!t) return;
  const c = { id:Date.now(), title:t, content:'' };
  book.chapters.push(c);
  book.current = c.id;
  saveAll();
  renderChapters();
  loadChapter(c.id);
}

function renderChapters(){
  const box = document.getElementById('chapters');
  box.innerHTML='';
  book.chapters.forEach(c=>{
    const d=document.createElement('div');
    d.className='chapter'+(c.id===book.current?' active':'');
    d.innerHTML = `
      ${c.title}
      <span style="float:right;color:red"
            onclick="deleteChapter(${c.id},event)">‚úñ</span>`;
    d.onclick=()=>loadChapter(c.id);
    box.appendChild(d);
  });
}

function deleteChapter(id,e){
  e.stopPropagation();
  if(!confirm("‡§π‡§ü‡§æ‡§â‡§®‡•á?")) return;
  book.chapters = book.chapters.filter(c=>c.id!==id);
  book.current = book.chapters[0]?.id || null;
  saveAll();
  renderChapters();
  if(book.current) loadChapter(book.current); else q.setText('');
}

function loadChapter(id){
  const c = book.chapters.find(x=>x.id===id);
  if(!c) return;
  book.current = id;
  q.root.innerHTML = c.content;
  renderChapters();
}

q.on('text-change',()=>{
  const c = book.chapters.find(x=>x.id===book.current);
  if(c){
    c.content = q.root.innerHTML;
    saveAll();
  }
});

/* ---------- CONTENT ---------- */
function addTopic(){
  q.clipboard.dangerouslyPasteHTML(
    q.getSelection(true).index,
    `<h2>‡§µ‡§ø‡§∑‡§Ø ‡§∂‡•Ä‡§∞‡•ç‡§∑‡§ï</h2><p><br></p>`
  );
}
function addPara(){
  q.insertText(q.getSelection(true).index, "‡§™‡§∞‡§ø‡§ö‡•ç‡§õ‡•á‡§¶ ‡§≤‡•á‡§ñ‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç...\n");
}

/* ---------- FONT COLOUR & HIGHLIGHT ---------- */
function hl(color){
  const r=q.getSelection();
  if(r) q.format('background', color);
}
function fc(color){
  const r=q.getSelection();
  if(r) q.format('color', color);
}

/* ---------- TABLE (exact rows/cols) ---------- */
let activeTable=null, activeCell=null;

document.addEventListener('click',e=>{
  const cell=e.target.closest('td,th');
  if(cell){
    activeCell=cell;
    activeTable=cell.closest('table');
  }
});

function addTable(){
  let rows=parseInt(prompt("‡§ï‡§§‡§ø Row?"));
  let cols=parseInt(prompt("‡§ï‡§§‡§ø Column?"));
  if(!rows||!cols) return;

  let html='<table class="table-grid" style="width:100%;border-collapse:collapse">';
  for(let r=0;r<rows;r++){
    html+='<tr>';
    for(let c=0;c<cols;c++) html+='<td></td>';
    html+='</tr>';
  }
  html+='</table><p><br></p>';
  q.clipboard.dangerouslyPasteHTML(q.getSelection(true).index, html);
}

function addRowBelow(){
  if(!activeCell) return;
  const row=activeCell.parentElement;
  const cols=row.children.length;
  const nr=activeTable.insertRow(row.rowIndex+1);
  for(let i=0;i<cols;i++) nr.insertCell();
}
function addColRight(){
  if(!activeCell) return;
  const ci=activeCell.cellIndex+1;
  [...activeTable.rows].forEach(r=>r.insertCell(ci));
}
function delRow(){
  if(activeCell) activeTable.deleteRow(activeCell.parentElement.rowIndex);
}
function delCol(){
  if(!activeCell) return;
  const ci=activeCell.cellIndex;
  [...activeTable.rows].forEach(r=>r.deleteCell(ci));
}
function toggleHeader(){
  if(!activeTable) return;
  const row=activeTable.rows[0];
  const isTh=row.cells[0].tagName==='TH';
  [...row.cells].forEach(c=>{
    const t=c.innerText;
    const n=document.createElement(isTh?'td':'th');
    n.innerText=t;
    c.replaceWith(n);
  });
}
function setTableStyle(t){
  if(!activeTable) return;
  activeTable.classList.remove('table-grid','table-borderless','table-zebra');
  if(t==='grid') activeTable.classList.add('table-grid');
  if(t==='borderless') activeTable.classList.add('table-borderless');
  if(t==='zebra') activeTable.classList.add('table-zebra');
}

/* ---------- PDF & READER ---------- */
function exportPDF(){
  html2pdf().from(document.getElementById('editor'))
    .save((book.title||'book')+'.pdf');
}
function openReader(){
  window.open('reader.html?book='+currentBookId,'_blank');
}

/* INIT */
if(!currentBookId) newBook();
else loadChapter(book.current);
</script>

</body>
</html>
